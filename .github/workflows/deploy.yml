name: Deploy to Unraid Registry

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, synapia-mail]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to registry.etiennestrobbe.ovh
        uses: docker/login-action@v3
        with:
          registry: registry.etiennestrobbe.ovh
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push frontend image
        run: |
          docker build -t registry.etiennestrobbe.ovh/synapia-mail-frontend:latest synapia-mail-frontend
          docker push registry.etiennestrobbe.ovh/synapia-mail-frontend:latest

      - name: Build and push backend image
        run: |
          docker build -t registry.etiennestrobbe.ovh/synapia-mail-backend:latest synapia-mail-backend
          docker push registry.etiennestrobbe.ovh/synapia-mail-backend:latest

      - name: Build and push ia-backend image
        run: |
          docker build -t registry.etiennestrobbe.ovh/synapia-mail-ia-backend:latest synapia-mail-ia-backend
          docker push registry.etiennestrobbe.ovh/synapia-mail-ia-backend:latest

      - name: Create deployment docker-compose file
        run: |
          cp docker-compose.yml docker-compose.deploy.yml
          # Replace build configurations with registry images for the three services
          # Frontend
          sed -i 's|    build:\n      context: ./synapia-mail-frontend\n      dockerfile: Dockerfile\n      args:\n        - NEXT_PUBLIC_API_BASE_URL=\${NEXT_PUBLIC_API_BASE_URL}|    image: registry.etiennestrobbe.ovh/synapia-mail-frontend:latest|' docker-compose.deploy.yml
          # Backend
          sed -i 's|    build:\n      context: ./synapia-mail-backend\n      dockerfile: Dockerfile|    image: registry.etiennestrobbe.ovh/synapia-mail-backend:latest|' docker-compose.deploy.yml
          # IA Backend
          sed -i 's|    build:\n      context: ./synapia-mail-ia-backend\n      dockerfile: Dockerfile|    image: registry.etiennestrobbe.ovh/synapia-mail-ia-backend:latest|' docker-compose.deploy.yml

      - name: Deploy with docker-compose
        env:
          ALLOWED_ORIGINS: ${{ vars.ALLOWED_ORIGINS }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          # MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}
          # MICROSOFT_CLIENT_SECRET: ${{ secrets.MICROSOFT_CLIENT_SECRET }}
          IA_BACKEND_API_KEY: ${{ secrets.IA_BACKEND_API_KEY }}
          CUSTOMER_POPULATE_API_KEY: ${{ vars.CUSTOMER_POPULATE_API_KEY }}
          MONGO_USERNAME: ${{ secrets.MONGO_USERNAME }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
          MICROSOFT_REDIRECT_URI: ${{ vars.MICROSOFT_REDIRECT_URI }}
          FRONTEND_URL: ${{ vars.FRONTEND_URL }}
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER }}
          LLM_DEFAULT_MODEL: ${{ vars.LLM_DEFAULT_MODEL }}
        run: |
          docker-compose -f docker-compose.deploy.yml up -d
